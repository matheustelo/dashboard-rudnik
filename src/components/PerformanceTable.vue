<template>
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
        {{ title }}
      </h3>
      <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
        <input
          v-model="nameFilter"
          type="text"
          placeholder="Filtrar por nome"
          class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full md:w-1/3 mb-2 md:mb-0"
        />
        <select
          v-model="roleFilter"
          class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full md:w-1/3 mb-2 md:mb-0"
        >
          <option value="">Todas as FunÃ§Ãµes</option>
          <option v-for="role in roleOptions" :key="role" :value="role">{{ getRoleLabel(role) }}</option>
        </select>
        <select
          v-model.number="perPage"
          class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full md:w-1/3"
        >
          <option v-for="opt in perPageOptions" :key="opt" :value="opt">{{ opt }} por pÃ¡gina</option>
        </select>
      </div>
      <!-- Table layout for medium screens and up -->
      <div class="hidden md:block">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PosiÃ§Ã£o</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Propostas</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meta Prop.</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendas</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meta Vendas</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tx. ConversÃ£o</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendas VÃ¡lidadas</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meta Fat.</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
             <tr v-for="(member, index) in paginatedTeamMembers" :key="member.id" :class="getRowClass((currentPage - 1) * perPage + index)"
                class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  <span v-if="(currentPage - 1) * perPage + index === 0"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">ðŸ¥‡
                    1Âº</span>
                  <span v-else-if="(currentPage - 1) * perPage + index === 1"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">ðŸ¥ˆ
                    2Âº</span>
                  <span v-else-if="(currentPage - 1) * perPage + index === 2"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">ðŸ¥‰
                    3Âº</span>
                  <span v-else class="text-gray-500">{{ (currentPage - 1) * perPage + index + 1 }}Âº</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center"><span
                        class="text-sm font-medium text-gray-700">{{ member.name.charAt(0).toUpperCase() }}</span></div>
                    <div class="ml-4">
                      <button @click="$emit('drill-down', member)"
                        class="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline">{{ member.name
                        }}</button>
                      <div class="text-sm text-gray-500">{{ member.email }}</div>
                      <div v-if="member.supervisorName" class="text-xs text-gray-400">Supervisor: {{
                        member.supervisorName }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap"><span :class="getRoleClass(member.role)"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">{{
                      getRoleLabel(member.role) }}</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex flex-col"><span class="font-medium">{{ member.performance.totalPropostas }}</span>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full bg-blue-500"
                        :style="{ width: Math.min((member.performance.totalPropostas / member.targets.metaPropostas) * 100, 100) + '%' }">
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div class="flex flex-col"><span>{{ member.targets.metaPropostas }}</span><span class="text-xs"
                      :class="getAchievementColor(member.achievements.propostasAchievement)">{{
                        member.achievements.propostasAchievement }}%</span></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex flex-col"><span class="font-medium">{{ member.performance.propostasConvertidas
                  }}</span>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full bg-green-500"
                        :style="{ width: Math.min((member.performance.propostasConvertidas / member.targets.metaVendas) * 100, 100) + '%' }">
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div class="flex flex-col"><span>{{ member.targets.metaVendas }}</span><span class="text-xs"
                      :class="getAchievementColor(member.achievements.vendasAchievement)">{{
                        member.achievements.vendasAchievement }}%</span></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-1">
                      <div class="text-sm text-gray-900">{{ member.performance.conversionRate }}%</div>
                      <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div
                          class="h-2 rounded-full"
                          :class="getConversionRateColor(member.performance.conversionRate, member.targets.metaConversao)"
                          :style="{ width: getConversionRateWidth(member.performance.conversionRate, member.targets.metaConversao) }"></div>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex flex-col"><span class="font-medium">R$ {{
                    formatCurrency(member.performance.faturamentoTotal) }}</span>
                    <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                      <div class="h-1 rounded-full bg-purple-500"
                        :style="{ width: Math.min((member.performance.faturamentoTotal / member.targets.metaFaturamento) * 100, 100) + '%' }">
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div class="flex flex-col"><span>R$ {{ formatCurrency(member.targets.metaFaturamento) }}</span><span
                      class="text-xs" :class="getAchievementColor(member.achievements.faturamentoAchievement)">{{
                        member.achievements.faturamentoAchievement }}%</span></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Condensed cards for small screens -->
      <div class="md:hidden space-y-4">
        <div v-for="(member, index) in paginatedTeamMembers" :key="member.id" class="p-4 bg-gray-50 rounded shadow">
          <div class="flex items-center mb-2">
           <span class="text-sm font-medium text-gray-700 mr-2">{{ (currentPage - 1) * perPage + index + 1 }}Âº</span>
            <button @click="$emit('drill-down', member)" class="text-sm font-medium text-blue-600 hover:text-blue-800">
              {{ member.name }}
            </button>
            <span :class="getRoleClass(member.role)"
              class="ml-auto inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium">
              {{ getRoleLabel(member.role) }}
            </span>
          </div>
          <div class="text-xs text-gray-500 mb-2">{{ member.email }}</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>
              <div class="text-gray-500">Propostas</div>
              <div class="font-medium">{{ member.performance.totalPropostas }}</div>
            </div>
            <div>
              <div class="text-gray-500">Meta Prop.</div>
              <div>{{ member.targets.metaPropostas }}</div>
            </div>
            <div>
              <div class="text-gray-500">Vendas</div>
              <div class="font-medium">{{ member.performance.propostasConvertidas }}</div>
            </div>
            <div>
              <div class="text-gray-500">Meta Vendas</div>
              <div>{{ member.targets.metaVendas }}</div>
            </div>
            <div>
              <div class="text-gray-500">Conv.</div>
              <div>{{ member.performance.conversionRate }}%</div>
            </div>
            <div>
              <div class="text-gray-500">Vendas VÃ¡lidadas</div>
              <div class="font-medium">R$ {{ formatCurrency(member.performance.faturamentoTotal) }}</div>
            </div>
            <div>
              <div class="text-gray-500">Meta Fat.</div>
              <div>R$ {{ formatCurrency(member.targets.metaFaturamento) }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-4 flex items-center justify-between" v-if="totalPages > 1">
        <button @click="prevPage" :disabled="currentPage === 1" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">Anterior</button>
        <span class="text-sm text-gray-600">PÃ¡gina {{ currentPage }} de {{ totalPages }}</span>
        <button @click="nextPage" :disabled="currentPage === totalPages" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">PrÃ³xima</button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, ref, watch, onMounted } from 'vue'
import { performanceService } from '../services/api'

const props = defineProps({
  title: { type: String, default: 'Performance Detalhada da Equipe' },
  filters: { type: Object, default: () => ({}) }
})

const emit = defineEmits(['drill-down'])

const teamMembers = ref([])
const totalMembers = ref(0)
// local refs for filters so we always have defined reactive values
const nameFilter = ref('')
const roleFilter = ref('')
// initialize local filters from incoming props if provided
if (props.filters) {
  nameFilter.value = props.filters.name || ''
  roleFilter.value = props.filters.role || ''
}
const currentPage = ref(1)
const perPage = ref(10)
const perPageOptions = [5, 10, 20, 50]

const roleOptions = computed(() => {
  const roles = teamMembers.value.map(m => m.role)
  return [...new Set(roles)]
})

const fetchData = async () => {
  const params = { supervisorId: 'all', ...props.filters, page: currentPage.value, limit: perPage.value }
  if (nameFilter.value) params.name = nameFilter.value
  if (roleFilter.value) params.role = roleFilter.value
  try {
    const { data } = await performanceService.getTeamPerformance(params)
    teamMembers.value = data.teamMembers || []
    totalMembers.value = data.teamStats?.totalMembers || 0
  } catch (error) {
    console.error('Erro ao carregar performance da equipe:', error)
  }
}

watch(
  () => props.filters,
  newFilters => {
    nameFilter.value = newFilters?.name || ''
    roleFilter.value = newFilters?.role || ''
    if (currentPage.value !== 1) {
      currentPage.value = 1
    } else {
      fetchData()
    }
  },
  { deep: true }
)

watch([nameFilter, roleFilter, perPage], () => {
  if (currentPage.value !== 1) {
    currentPage.value = 1
  } else {
    fetchData()
  }
})

watch(currentPage, fetchData)

onMounted(fetchData)

const totalPages = computed(() => Math.ceil(totalMembers.value / perPage.value))
const paginatedTeamMembers = computed(() => teamMembers.value)

function nextPage() {
  if (currentPage.value < totalPages.value) currentPage.value++
}

function prevPage() {
  if (currentPage.value > 1) currentPage.value--
}

const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0)
const getRoleClass = (role) => ({
  vendedor: 'bg-blue-100 text-blue-800',
  representante: 'bg-purple-100 text-purple-800',
  parceiro_comercial: 'bg-green-100 text-green-800',
  supervisor: 'bg-indigo-100 text-indigo-800',
  preposto: 'bg-teal-100 text-teal-800',
  representante_premium: 'bg-yellow-100 text-yellow-800',
}[role] || 'bg-gray-100 text-gray-800')
const getRoleLabel = (role) => ({
  vendedor: 'Vendedor',
  representante: 'Representante',
  parceiro_comercial: 'Parceiro Comercial',
  supervisor: 'Supervisor',
  preposto: 'Preposto',
  representante_premium: 'Representante Premium',
}[role] || role)
const getRowClass = (index) => (index < 3 ? 'bg-yellow-50' : '')
const getConversionRateColor = (rate, meta) => {
  if (meta) {
    if (rate >= meta) return 'bg-green-500'
    if (rate >= meta * 0.75) return 'bg-yellow-500'
    return 'bg-red-500'
  }
  if (rate >= 75) return 'bg-green-500'
  if (rate >= 50) return 'bg-yellow-500'
  return 'bg-red-500'
}

const getConversionRateWidth = (rate, meta) => {
  if (meta) return Math.min((rate / meta) * 100, 100) + '%'
  return Math.min(rate, 100) + '%'
}

const getAchievementColor = (percentage) => {
  const pct = parseFloat(percentage)
  if (pct >= 100) return 'text-green-600 font-medium'
  if (pct >= 75) return 'text-yellow-600 font-medium'
  return 'text-red-600 font-medium'
}
</script>
